From fb38cc5d3ea9b599279324f055f1ad3b990ac274 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Jan=20Kundr=C3=A1t?= <jan.kundrat@cesnet.cz>
Date: Wed, 22 Mar 2017 00:32:56 +0100
Subject: [PATCH] Do not execute binaries during `make install`

---
 keystored/CMakeLists.txt | 78 ------------------------------------------------
 1 file changed, 78 deletions(-)

diff --git a/keystored/CMakeLists.txt b/keystored/CMakeLists.txt
index 277322a..76caca6 100644
--- a/keystored/CMakeLists.txt
+++ b/keystored/CMakeLists.txt
@@ -79,87 +79,9 @@ if (NOT SR_PLUGINS_DIR)
     message(FATAL_ERROR "Cannot get sysrepo plugins directory due to missing pkg-config, set SR_PLUGINS_DIR manually.")
 endif()
 
-# find programs
-if (NOT SYSREPOCTL_EXECUTABLE)
-    find_program(SYSREPOCTL_EXECUTABLE sysrepoctl)
-endif()
-if (NOT SYSREPOCTL_EXECUTABLE)
-    message(FATAL_ERROR "Unable to find sysrepoctl, set SYSREPOCTL_EXECUTABLE manually.")
-endif()
-
-if (NOT SYSREPOCFG_EXECUTABLE)
-    find_program(SYSREPOCFG_EXECUTABLE sysrepocfg)
-endif()
-if (NOT SYSREPOCFG_EXECUTABLE)
-    message(FATAL_ERROR "Unable to find sysrepocfg, set SYSREPOCFG_EXECUTABLE manually.")
-endif()
-
-if (NOT CHMOD_EXECUTABLE)
-    find_program(CHMOD_EXECUTABLE chmod)
-endif()
-if (NOT CHMOD_EXECUTABLE)
-    message(FATAL_ERROR "Unable to find chmod, set CHMOD_EXECUTABLE manually.")
-endif()
-
 # create the keys directory with correct permissions
 install(DIRECTORY DESTINATION ${KEYSTORED_KEYS_DIR}
         DIRECTORY_PERMISSIONS OWNER_WRITE OWNER_READ OWNER_EXECUTE)
 
-# install all the required modules and enable features
-install(CODE "
-    execute_process(COMMAND ${SYSREPOCTL_EXECUTABLE} -l RESULT_VARIABLE RET OUTPUT_VARIABLE INSTALLED_MODULES ERROR_VARIABLE OUT)
-    if (RET)
-        string(REPLACE \"\\n\" \"\\n  \" OUT \${OUT})
-        message(FATAL_ERROR \"  Command sysrepoctl list failed:\n  \${OUT}\")
-    endif()
-
-    string(REGEX MATCH \"ietf-keystore [^\\n]*\" INSTALLED_MODULE_LINE \"\${INSTALLED_MODULES}\")
-    if (NOT INSTALLED_MODULE_LINE)
-        message(STATUS \"Importing module ietf-keystore into sysrepo...\")
-        execute_process(COMMAND ${SYSREPOCTL_EXECUTABLE} -i -g ${CMAKE_SOURCE_DIR}/../modules/ietf-keystore.yang -o root:root -p 600 RESULT_VARIABLE RET OUTPUT_VARIABLE OUT ERROR_VARIABLE OUT)
-        if (RET)
-            string(REPLACE \"\\n\" \"\\n  \" OUT \${OUT})
-            message(FATAL_ERROR \"  Command sysrepoctl install failed:\\n  \${OUT}\")
-        endif()
-
-        execute_process(COMMAND ${SYSREPOCTL_EXECUTABLE} -m ietf-keystore -t RESULT_VARIABLE RET OUTPUT_VARIABLE OUT ERROR_VARIABLE OUT)
-        if (RET)
-            string(REPLACE \"\\n\" \"\\n  \" OUT \${OUT})
-            message(FATAL_ERROR \"  Command sysrepoctl init failed:\\n  \${OUT}\")
-        endif()
-
-    else()
-        message(STATUS \"Module ietf-keystore already in sysrepo.\")
-    endif()")
-
-# import stock OpenSSH RSA key
-install(CODE "
-    execute_process(COMMAND ${SYSREPOCFG_EXECUTABLE} -d startup --export ietf-keystore RESULT_VARIABLE RET OUTPUT_VARIABLE OUT ERROR_VARIABLE OUT)
-    if (RET)
-        string(REPLACE \"\\n\" \"\\n  \" OUT \${OUT})
-        message(FATAL_ERROR \"  Command sysrepocfg export failed:\\n  \${OUT}\")
-    endif()
-
-    if (OUT)
-        message(STATUS \"Some ietf-keystore configuration set, no keys will be imported.\")
-    elseif(NOT EXISTS \"/etc/ssh/ssh_host_rsa_key\")
-        message(WARNING \"Default OpenSSH RSA host key \\\"/etc/ssh/ssh_host_rsa_key\\\" not found so a key will have to be imported or generated manually for netopeer2-server to use.\")
-    else()
-        message(STATUS \"Importing stock OpenSSH RSA key.\")
-        file(READ /etc/ssh/ssh_host_rsa_key RSA_KEY)
-        file(WRITE ${KEYSTORED_KEYS_DIR}/ssh_host_rsa_key.pem \${RSA_KEY})
-        execute_process(COMMAND ${CHMOD_EXECUTABLE} go-rw ${KEYSTORED_KEYS_DIR}/ssh_host_rsa_key.pem)
-        execute_process(COMMAND ${OPENSSL_EXECUTABLE} rsa -pubout -in ${KEYSTORED_KEYS_DIR}/ssh_host_rsa_key.pem -out ${KEYSTORED_KEYS_DIR}/ssh_host_rsa_key.pub.pem RESULT_VARIABLE RET OUTPUT_VARIABLE OUT ERROR_VARIABLE OUT)
-        if (RET)
-            string(REPLACE \"\\n\" \"\\n  \" OUT \${OUT})
-            message(FATAL_ERROR \"  Command openssl generate public key failed:\\n  \${OUT}\")
-        endif()
-        execute_process(COMMAND ${SYSREPOCFG_EXECUTABLE} -d startup -i ${CMAKE_SOURCE_DIR}/stock_key_config.xml ietf-keystore RESULT_VARIABLE RET OUTPUT_VARIABLE OUT ERROR_VARIABLE OUT)
-        if (RET)
-            string(REPLACE \"\\n\" \"\\n  \" OUT \${OUT})
-            message(FATAL_ERROR \"  Command sysrepocfg import failed:\\n  \${OUT}\")
-        endif()
-    endif()")
-
 # plugins should be installed into sysrepo plugins dir
 install(TARGETS keystored DESTINATION ${SR_PLUGINS_DIR})
-- 
2.10.2

